<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔌 Vanilla 3000 - Smart Energy Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.x/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --success-color: #48bb78;
            --error-color: #f56565;
            --warning-color: #ed8936;
            --info-color: #4299e1;
        }
        html[data-theme="dark"] {
            --primary-gradient: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --card-bg: rgba(45, 55, 72, 0.95);
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--primary-gradient); min-height: 100vh; padding: 1rem; color: var(--text-primary); transition: background 0.3s ease, color 0.3s ease; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--card-bg); border-radius: 1.5rem; padding: 2rem; box-shadow: 0 20px 40px var(--shadow-color); backdrop-filter: blur(10px); min-height: calc(100vh - 2rem); display: flex; flex-direction: column; transition: background 0.3s ease, box-shadow 0.3s ease; }
        .header { text-align: center; margin-bottom: 2rem; position: relative; }
        .header h1 { font-size: 3rem; font-weight: 800; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
        .header p { font-size: 1rem; color: var(--text-secondary); }
        .header-controls { position: absolute; top: 0; right: 0; display: flex; gap: 0.75rem; }
        .header-btn { width: 3rem; height: 3rem; border-radius: 50%; border: 2px solid var(--border-color); background: var(--card-bg); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; transition: all 0.3s ease; }
        .header-btn:hover { background: var(--primary-gradient); color: white; border-color: transparent; }
        .main-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; flex-grow: 1; }
        .section { background: var(--card-bg); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-color); box-shadow: 0 4px 15px var(--shadow-color); transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; }
        .left-column .section:last-child, .right-column .section:last-child { margin-bottom: 0; }
        .section-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
        .status-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .metric-card { background: var(--primary-gradient); color: white; padding: 1.5rem; border-radius: 1rem; text-align: center; transition: transform 0.2s ease, background 0.3s ease; }
        .metric-card:hover { transform: translateY(-2px); }
        .metric-label { font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem; }
        .metric-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem; }
        .metric-unit { font-size: 0.875rem; opacity: 0.8; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; min-width: 100px; }
        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f56565, #e53e3e); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #a0aec0, #718096); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .input-field { width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 0.5rem; background: var(--card-bg); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .control-group, .input-group { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .control-group { flex-wrap: wrap; }
        .input-group { align-items: center; }
        .control-group .btn, .input-group .input-field { flex: 1; }
        .input-group .btn { flex-grow: 0; }
        .connection-status { padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; font-weight: 600; transition: all 0.3s ease;}
        .status-dot { width: 12px; height: 12px; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .connection-status.connected { background: rgba(72, 187, 120, 0.1); color: var(--success-color); border-left: 5px solid var(--success-color); }
        .connection-status.connecting { background: rgba(237, 137, 54, 0.1); color: var(--warning-color); border-left: 5px solid var(--warning-color); }
        .connection-status.disconnected { background: rgba(245, 101, 101, 0.1); color: var(--error-color); border-left: 5px solid var(--error-color); }
        .connection-status.connected .status-dot { background-color: var(--success-color); }
        .connection-status.connecting .status-dot { background-color: var(--warning-color); }
        .connection-status.disconnected .status-dot { background-color: var(--error-color); }
        .chart-container { position: relative; height: 400px; margin-top: 1rem; }
        .chart-controls { display: flex; gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap; justify-content: center; }
        .chart-btn { padding: 0.5rem 1rem; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-primary); border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease; }
        .chart-btn.active, .chart-btn:hover { background: var(--primary-gradient); color: white; border-color: transparent; }
        .notifications-panel { max-height: 250px; overflow-y: auto; padding-right: 10px; }
        .notification { padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .notification-info { background: rgba(66, 153, 225, 0.1); border-color: var(--info-color); color: var(--info-color); }
        .notification-success { background: rgba(72, 187, 120, 0.1); border-color: var(--success-color); color: var(--success-color); }
        .notification-warning { background: rgba(237, 137, 54, 0.1); border-color: var(--warning-color); color: var(--warning-color); }
        .notification-error { background: rgba(245, 101, 101, 0.1); border-color: var(--error-color); color: var(--error-color); }
        .usage-tracker { text-align: center; padding: 2rem; background: var(--primary-gradient); color: white; border-radius: 1rem; margin-bottom: 1.5rem; }
        .usage-time { font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
        .budget-time-display { background: rgba(118, 75, 162, 0.1); border-radius: 0.75rem; padding: 1rem; margin-top: 0.75rem; text-align: center; font-weight: 600; display: flex; flex-direction: column; gap: 0.5rem; }
        .budget-time-display .label { font-size: 0.8rem; color: var(--text-secondary); }
        .budget-time-display .value { font-size: 1.25rem; font-weight: 800; }
        .schedule-group { display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: center; margin-bottom: 1rem;}
        .schedule-group label { font-weight: 600; color: var(--text-secondary); }
        pre.code-block { background-color: #f3f4f6; border-radius: 0.5rem; padding: 1rem; font-family: monospace; color: #1f2937; white-space: pre-wrap; word-break: break-all; transition: all 0.3s ease; }
        html[data-theme="dark"] pre.code-block { background-color: #1f2937; color: #d1d5db; }
        @media (max-width: 1024px) { .main-grid { grid-template-columns: 1fr; } .header-controls { position: static; justify-content: center; margin-top: 1rem; } }
        @media (max-width: 640px) { body { padding: .25rem; } .container { padding: .75rem; } .header h1 { font-size: 1.8rem; } .header p { font-size: .85rem; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔌 Vanilla 3000</h1>
            <p>Smart Energy Monitor & Control Panel</p>
            <div class="header-controls">
                <button class="header-btn" onclick="toggleDarkMode()" id="themeToggle">🌙</button>
                <button class="header-btn" onclick="toggleFullscreen()" id="fullscreenToggle">⛶</button>
            </div>
        </div>

        <div class="main-grid">
            <div class="left-column">
                <div class="section" id="firebaseSetupSection" style="border-color: var(--error-color); border-width: 2px;">
                    <div class="section-title">🚨 Important Firebase Setup</div>
                    <p class="text-sm text-secondary mb-2">
                        If the connection status is 'Offline' and you see a <strong>permission_denied</strong> error, you must update your Firebase security rules.
                    </p>
                    <p class="text-sm text-secondary mb-4">
                        Go to your Firebase project's <strong>Realtime Database > Rules</strong> tab and replace the contents with the code below to allow this app to connect.
                    </p>
                    <pre class="code-block mb-4"><code>{
  "rules": {
    ".read": true,
    ".write": true
  }
}</code></pre>
                    <a href="https://console.firebase.google.com/project/vanilla3000-4f38d/database/vanilla3000-4f38d-default-rtdb/rules" target="_blank" class="btn btn-danger w-full">Open Firebase Rules Editor</a>
                </div>

                <div class="section">
                    <div class="section-title">🌐 Connection</div>
                    <div id="connectionStatus" class="connection-status disconnected">
                        <div class="status-dot"></div>
                        <span id="connectionStatusText">Offline</span>
                    </div>
                </div>

                <div class="section" id="wifiSetupSection">
                    <div class="section-title">📶 WiFi & Bluetooth Setup</div>
                    <p class="text-sm text-secondary mb-4">Connect via Bluetooth for initial WiFi setup or for local control if WiFi is unavailable.</p>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="connectBluetooth()" id="connectBLEBtn">Connect Bluetooth</button>
                        <button class="btn btn-danger" onclick="disconnectBluetooth()" id="disconnectBLEBtn" style="display: none;">Disconnect</button>
                    </div>
                    <div class="input-group">
                        <input type="text" id="wifiSsidInput" class="input-field" placeholder="WiFi Network Name (SSID)">
                    </div>
                    <div class="input-group">
                        <input type="password" id="wifiPassInput" class="input-field" placeholder="WiFi Password">
                    </div>
                    <div class="control-group">
                        <button class="btn btn-success" onclick="provisionWifi()" id="provisionBtn" disabled>Send WiFi to Device</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">⚡ Energy Rate Configuration</div>
                    <div class="input-group">
                        <input type="number" id="kwhRateInput" class="input-field" placeholder="kWh Rate (e.g., 14.50)" min="0" step="any">
                        <button class="btn btn-primary" onclick="setKwhRate()" id="setKwhRateBtn">Set Rate</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">🎛️ Device Control</div>
                    <div class="control-group">
                        <button class="btn btn-success" onclick="sendCommand('ON')" id="onBtn">Turn ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('OFF')" id="offBtn">Turn OFF</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">📅 Schedule Control</div>
                    <div class="schedule-group">
                        <label for="scheduleOnTime">ON Time:</label>
                        <input type="time" id="scheduleOnTime" class="input-field">
                    </div>
                    <div class="schedule-group">
                        <label for="scheduleOffTime">OFF Time:</label>
                        <input type="time" id="scheduleOffTime" class="input-field">
                    </div>
                    <div class="control-group">
                        <button class="btn btn-primary" onclick="setSchedule()" id="scheduleBtn">Set Schedule</button>
                        <button class="btn btn-danger" onclick="deleteSchedule()" id="deleteScheduleBtn">Delete Schedule</button>
                    </div>
                    <div id="activeScheduleDisplay" class="budget-time-display" style="display:none;">
                        <span class="label">Active Schedule</span>
                        <span class="value" id="activeSchedule"></span>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">💰 Budget Control</div>
                    <div class="input-group">
                        <input type="number" id="budgetInput" class="input-field" placeholder="Amount in ₱" min="0" step="0.01">
                        <button class="btn btn-primary" onclick="setBudget()" id="budgetBtn">Set</button>
                        <button class="btn btn-danger" onclick="deleteBudget()" id="deleteBudgetBtn">Delete</button>
                    </div>
                    <div id="remainingBudgetDisplay" class="budget-time-display" style="display:none;">
                        <span class="label">Remaining Budget</span>
                        <span class="value" id="remainingBudget">₱0.00</span>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">⏰ Timer Control</div>
                    <div class="input-group">
                        <input type="number" id="timerHoursInput" class="input-field" placeholder="Hours" min="0" max="23">
                        <input type="number" id="timerMinutesInput" class="input-field" placeholder="Minutes" min="0" max="59">
                    </div>
                    <div class="control-group">
                        <button class="btn btn-primary" onclick="setTimer()" id="timerBtn">Set Timer</button>
                        <button class="btn btn-danger" onclick="deleteTimer()" id="deleteTimerBtn">Delete Timer</button>
                    </div>
                    <div id="remainingTimerDisplay" class="budget-time-display" style="display:none;">
                        <span class="label">Time Remaining</span>
                        <span class="value" id="remainingTimer">00:00:00</span>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">🔄 Reset Functions</div>
                    <div class="control-group">
                        <button class="btn btn-warning" onclick="sendCommand('RESET_KWH')" id="resetUsageBtn">Reset Usage</button>
                        <button class="btn btn-warning" onclick="sendCommand('RESET_RUNTIME')" id="resetTimeBtn">Reset Runtime</button>
                        <button class="btn btn-danger" onclick="confirmResetAll()" id="resetAllBtn">Reset All</button>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="status-panel">
                    <div class="metric-card"><div class="metric-label">Voltage</div><div class="metric-value" id="voltage">0.0</div><div class="metric-unit">V</div></div>
                    <div class="metric-card"><div class="metric-label">Current</div><div class="metric-value" id="current">0.00</div><div class="metric-unit">A</div></div>
                    <div class="metric-card"><div class="metric-label">Power</div><div class="metric-value" id="power">0.0</div><div class="metric-unit">W</div></div>
                    <div class="metric-card"><div class="metric-label">Total kWh</div><div class="metric-value" id="energy">0.000</div><div class="metric-unit">kWh</div></div>
                    <div class="metric-card"><div class="metric-label">Total Cost</div><div class="metric-value" id="cost">₱0.00</div><div class="metric-unit">PHP</div></div>
                </div>
                <div class="usage-tracker"><div class="usage-time" id="usageTime">00:00:00</div><div id="usageStatus">Active Session Runtime</div></div>
                
                <div class="section">
                    <div class="section-title">📊 Energy Usage Chart</div>
                    <div class="chart-container"><canvas id="usageChart"></canvas></div>
                    <div class="chart-controls">
                        <button class="chart-btn" onclick="toggleChartType('power')" id="chartTypePower">Power</button>
                        <button class="chart-btn" onclick="toggleChartType('kwh')" id="chartTypeKwh">kWh</button>
                        <button class="chart-btn" onclick="toggleChartType('cost')" id="chartTypeCost">Cost</button>
                        <button class="chart-btn" onclick="setChartTimeRange('1H')" id="timeRange1H">1H</button>
                        <button class="chart-btn" onclick="setChartTimeRange('24H')" id="timeRange24H">24H</button>
                        <button class="chart-btn" onclick="setChartTimeRange('7D')" id="timeRange7D">7D</button>
                        <button class="chart-btn active" onclick="setChartTimeRange('All')" id="timeRangeAll">All</button>
                        <button class="chart-btn btn-secondary" onclick="resetChartZoom()" id="resetZoomBtn">Reset View</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">🔔 Live Notifications</div>
                    <div class="notifications-panel" id="notificationsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAkMrAaDqOoER0i5WJoDyqReiplqiBQYx4",
            authDomain: "vanilla3000-4f38d.firebaseapp.com",
            databaseURL: "https://vanilla3000-4f38d-default-rtdb.firebaseio.com",
            projectId: "vanilla3000-4f38d",
            storageBucket: "vanilla3000-4f38d.appspot.com",
            messagingSenderId: "569470914348",
            appId: "1:569470914348:web:1c1411c70fe59379dc2689"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // --- GLOBAL STATE ---
        let bleDevice = null, bleRxCharacteristic = null, chart = null;
        let isFirebaseConnected = false;
        let connectionMode = 'none'; // Can be 'firebase', 'bluetooth', or 'none'
        let bleDataBuffer = '';
        let currentChartType = 'power';
        const chartData = {
            power: JSON.parse(localStorage.getItem('chartData_power') || '[]'),
            cost: JSON.parse(localStorage.getItem('chartData_cost') || '[]'),
            kwh: JSON.parse(localStorage.getItem('chartData_kwh') || '[]'),
            labels: JSON.parse(localStorage.getItem('chartData_labels') || '[]')
        };
        
        // --- UI ELEMENTS ---
        const connectionStatusEl = document.getElementById('connectionStatus');
        const connectionStatusTextEl = document.getElementById('connectionStatusText');
        const provisionBtn = document.getElementById('provisionBtn');
        const connectBLEBtn = document.getElementById('connectBLEBtn');
        const disconnectBLEBtn = document.getElementById('disconnectBLEBtn');
        
        // --- CORE FUNCTIONS ---
        async function sendCommand(action, value = null) {
            const command = (value !== null) ? `${action}:${value}` : `${action}`;

            if (connectionMode === 'firebase') {
                try {
                    await set(ref(database, '/smart_plug/command'), command);
                    console.log(`Firebase command sent: ${command}`);
                } catch (error) {
                    addLiveNotification(`Firebase command failed: ${error.message}`, 'error');
                }
            } else if (connectionMode === 'bluetooth') {
                if (!bleDevice?.gatt.connected || !bleRxCharacteristic) return addLiveNotification('Bluetooth not connected.', 'error');
                try {
                    await bleRxCharacteristic.writeValueWithoutResponse(new TextEncoder().encode(command + '\n'));
                    console.log(`Bluetooth command sent: ${command}`);
                } catch (error) {
                    addLiveNotification(`Bluetooth command failed: ${error.message}`, 'error');
                }
            } else {
                addLiveNotification('Not connected. Cannot send command.', 'error');
            }
        }

        function setupFirebaseListener() {
            const deviceDataRef = ref(database, '/smart_plug/status_string');
            onValue(deviceDataRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.length > 10) { // Check for valid data
                    if (!isFirebaseConnected) {
                        isFirebaseConnected = true;
                        updateConnectionStatus('connected', 'firebase');
                        addLiveNotification('Connected to device via Firebase.', 'success');
                    }
                    parseAndDisplayData(data);
                } else {
                    if(isFirebaseConnected) {
                        isFirebaseConnected = false;
                        if (connectionMode !== 'bluetooth') {
                            updateConnectionStatus('disconnected');
                        }
                        addLiveNotification('Device offline from Firebase.', 'warning');
                    }
                }
            }, (error) => {
                console.error("Firebase listener error:", error);
                isFirebaseConnected = false;
                if (connectionMode !== 'bluetooth') {
                    updateConnectionStatus('disconnected');
                }
                addLiveNotification('Firebase permission denied. Please see the "Important Firebase Setup" section.', 'error');
            });
        }
        
        async function connectBluetooth() {
            if (!navigator.bluetooth) return addLiveNotification('Web Bluetooth is not supported in this browser.', 'error');
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32_Power_Monitor' }],
                    optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
                });
                
                updateConnectionStatus('connecting', 'bluetooth');
                device.addEventListener('gattserverdisconnected', onBLEDisconnected);
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
                bleRxCharacteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
                const notifyCharacteristic = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');
                await notifyCharacteristic.startNotifications();
                notifyCharacteristic.addEventListener('characteristicvaluechanged', onBLECharacteristicValueChanged);
                
                bleDevice = device;
                updateConnectionStatus('connected', 'bluetooth');
                addLiveNotification(`Connected via Bluetooth to ${bleDevice.name}.`, 'success');
                
            } catch(error) {
                if (error.name !== 'NotFoundError') {
                    addLiveNotification(`Bluetooth connection failed: ${error.message}`, 'error');
                }
                if (!isFirebaseConnected) updateConnectionStatus('disconnected');
            }
        }

        function onBLEDisconnected() {
            addLiveNotification('Bluetooth disconnected.', 'warning');
            if (bleDevice) bleDevice.removeEventListener('gattserverdisconnected', onBLEDisconnected);
            bleDevice = null;
            bleRxCharacteristic = null;
            if (isFirebaseConnected) {
                updateConnectionStatus('connected', 'firebase');
            } else {
                updateConnectionStatus('disconnected');
            }
        }
        
        async function disconnectBluetooth() {
            if (bleDevice?.gatt.connected) {
                await bleDevice.gatt.disconnect();
            }
        }
        
        function onBLECharacteristicValueChanged(event) {
            const receivedChunk = new TextDecoder().decode(event.target.value);
            bleDataBuffer += receivedChunk;
            let newlineIndex;
            while ((newlineIndex = bleDataBuffer.indexOf('\n')) !== -1) {
                const completeLine = bleDataBuffer.substring(0, newlineIndex).trim();
                bleDataBuffer = bleDataBuffer.substring(newlineIndex + 1);
                if (completeLine) {
                    if (completeLine.startsWith('ALERT:')) handleAlert(completeLine);
                    else if (completeLine.includes('V:') && completeLine.includes('I:')) parseAndDisplayData(completeLine);
                }
            }
        }

        async function provisionWifi() {
            const ssid = document.getElementById('wifiSsidInput').value;
            const pass = document.getElementById('wifiPassInput').value;
            if (!ssid) return addLiveNotification("Please enter a WiFi Network Name (SSID).", 'error');
            const command = `PROVISION:${ssid},${pass}`;
            await sendCommand(command); // This will send via BT if connected
            addLiveNotification("WiFi credentials sent. The device will reboot and attempt to connect.", 'info');
            setTimeout(() => { if (bleDevice?.gatt.connected) bleDevice.gatt.disconnect(); }, 1000);
        }

        function updateConnectionStatus(status, type = 'none') {
            connectionMode = (status === 'connected') ? type : 'none';
            
            connectBLEBtn.style.display = (status === 'connected' && type === 'bluetooth') ? 'none' : 'flex';
            disconnectBLEBtn.style.display = (status === 'connected' && type === 'bluetooth') ? 'flex' : 'none';
            provisionBtn.disabled = !(status === 'connected' && type === 'bluetooth');

            connectionStatusEl.className = `connection-status ${status}`;
            const statusTextMap = {
                connected: `${type.charAt(0).toUpperCase() + type.slice(1)} Connected`,
                connecting: `Connecting to ${type}...`,
                disconnected: 'Offline'
            };
            connectionStatusTextEl.textContent = statusTextMap[status] || 'Offline';
            
            const isControlEnabled = (status === 'connected');
            document.querySelectorAll('.btn').forEach(btn => {
                if (!btn.closest('#wifiSetupSection') && !btn.closest('#firebaseSetupSection')) {
                    btn.disabled = !isControlEnabled;
                }
            });
        }

        function parseAndDisplayData(dataString) {
            const metrics = {};
            dataString.split(',').forEach(part => {
                const i = part.indexOf(':');
                if (i > -1) metrics[part.substring(0, i).trim()] = part.substring(i + 1).trim();
            });

            document.getElementById('voltage').textContent = parseFloat(metrics.V || 0).toFixed(1);
            document.getElementById('current').textContent = parseFloat(metrics.I || 0).toFixed(2);
            document.getElementById('power').textContent = parseFloat(metrics.P || 0).toFixed(1);
            document.getElementById('energy').textContent = parseFloat(metrics.KWH || 0).toFixed(3);
            document.getElementById('cost').textContent = `₱${parseFloat(metrics.COST || 0).toFixed(2)}`;
            document.getElementById('usageStatus').textContent = `Device: ${metrics.Relay || 'N/A'}`;
            const s = parseInt(metrics.RUNTIME || '0', 10);
            document.getElementById('usageTime').textContent = `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor(s%3600/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        
            const timerDisplay = document.getElementById('remainingTimerDisplay');
            if (metrics.REM_TIME && parseInt(metrics.REM_TIME, 10) > 0) {
                const s = parseInt(metrics.REM_TIME, 10);
                document.getElementById('remainingTimer').textContent = `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor(s%3600/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
                timerDisplay.style.display = 'flex';
            } else { timerDisplay.style.display = 'none'; }
            
            const budgetDisplay = document.getElementById('remainingBudgetDisplay');
            if (metrics.REM_BUDGET && parseFloat(metrics.REM_BUDGET) > 0) {
                document.getElementById('remainingBudget').textContent = `₱${parseFloat(metrics.REM_BUDGET).toFixed(2)}`;
                budgetDisplay.style.display = 'flex';
            } else { budgetDisplay.style.display = 'none'; }
            
            const scheduleDisplay = document.getElementById('activeScheduleDisplay');
            if (metrics.SCHED_ACTIVE && parseInt(metrics.SCHED_ACTIVE) === 1) {
                const [onH, onM] = metrics.SCHED_ON.split(':');
                const [offH, offM] = metrics.SCHED_OFF.split(':');
                const format12Hour = (h, m) => `${(parseInt(h)%12 || 12)}:${m.padStart(2,'0')} ${parseInt(h)>=12 ? 'PM' : 'AM'}`;
                document.getElementById('activeSchedule').textContent = `ON: ${format12Hour(onH,onM)} | OFF: ${format12Hour(offH,offM)}`;
                scheduleDisplay.style.display = 'flex';
            } else { scheduleDisplay.style.display = 'none'; }
            
             addDataPoint(parseFloat(metrics.P || 0), parseFloat(metrics.COST || 0), parseFloat(metrics.KWH || 0));
        }
        
        function handleAlert(alertData) {
            const message = alertData.split('|')[1] || 'Device alert!';
            addLiveNotification(`🚨 ${message}`, 'warning');
            if (Notification.permission === "granted") new Notification('Vanilla 3000 Alert', { body: message });
        }

        // --- CHART FUNCTIONS ---
        function initializeChart() {
            const ctx = document.getElementById('usageChart').getContext('2d');
            chart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'hour' } }, y: { beginAtZero: true, title: { display: true } } },
                    plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } }
                }
            });
            toggleChartType(currentChartType);
            setChartTimeRange('All');
        }

        function addDataPoint(power, cost, kwh) {
            const nowISO = new Date().toISOString();
            chartData.labels.push(nowISO); 
            chartData.power.push(power); 
            chartData.cost.push(cost); 
            chartData.kwh.push(kwh);
            
            const maxPoints = 2880; // Keep 48 hours of 1-minute data
            while (chartData.labels.length > maxPoints) { 
                Object.keys(chartData).forEach(key => chartData[key].shift()); 
            }
            Object.keys(chartData).forEach(key => localStorage.setItem(`chartData_${key}`, JSON.stringify(chartData[key])));
            
            if (chart?.data.datasets.length > 0) {
                chart.data.labels.push(new Date(nowISO));
                chart.data.datasets[0].data.push({power, cost, kwh}[currentChartType]);
                while(chart.data.labels.length > maxPoints) { 
                    chart.data.labels.shift(); 
                    chart.data.datasets[0].data.shift(); 
                }
                if(!chart.isZoomedOrPanned()) chart.update('none');
            }
        }

        function updateChart() {
            if (!chart) return;
            const labelMap = { power: 'Power (W)', kwh: 'Energy (kWh)', cost: 'Cost (PHP)' };
            const colorMap = { power: '#667eea', kwh: '#38a169', cost: '#ed8936' };
            
            const dataPoints = chartData[currentChartType] || [];
            
            chart.data.labels = chartData.labels.map(l => new Date(l));
            chart.data.datasets = [{
                data: dataPoints, label: labelMap[currentChartType], borderColor: colorMap[currentChartType],
                backgroundColor: colorMap[currentChartType] + '1A', tension: 0.1, fill: true, pointRadius: 0, borderWidth: 1.5
            }];
            chart.options.scales.y.title.text = labelMap[currentChartType];
            
            // Apply theme colors to chart
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#e2e8f0';
            const textColor = isDark ? '#a0aec0' : '#718096';
            chart.options.scales.x.ticks.color = textColor;
            chart.options.scales.x.grid.color = gridColor;
            chart.options.scales.y.ticks.color = textColor;
            chart.options.scales.y.grid.color = gridColor;
            chart.options.scales.y.title.color = textColor;

            chart.update('none');
        }

        function toggleChartType(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-controls .chart-btn[id^="chartType"]').forEach(b => b.classList.remove('active'));
            document.getElementById(`chartType${type.charAt(0).toUpperCase() + type.slice(1)}`)?.classList.add('active');
            updateChart();
        }

        function setChartTimeRange(period) {
            if (!chart) return;
            const now = new Date();
            let minTime = null;
            if (period === '1H') minTime = new Date(now.getTime() - 60 * 60 * 1000);
            else if (period === '24H') minTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            else if (period === '7D') minTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            chart.options.scales.x.min = minTime;
            chart.options.scales.x.max = now;
            chart.update('normal');
            
            document.querySelectorAll('.chart-controls .chart-btn[id^="timeRange"]').forEach(b => b.classList.remove('active'));
            document.getElementById(`timeRange${period}`).classList.add('active');
        }

        function resetChartZoom() { if(chart) chart.resetZoom(); }
        
        // --- UI & HELPER FUNCTIONS ---
        function setKwhRate() { 
            const rate = document.getElementById('kwhRateInput').value;
            if (parseFloat(rate) > 0) {
                sendCommand('RATE', rate);
                addLiveNotification(`Set kWh rate to ${rate}`, 'info');
            } else {
                addLiveNotification('Please enter a valid rate.', 'error');
            }
        }
        function setBudget() { sendCommand('SET_BUDGET', document.getElementById('budgetInput').value); }
        function deleteBudget() { sendCommand('SET_BUDGET', 0); }
        function setTimer() { 
            const h = parseInt(document.getElementById('timerHoursInput').value || '0');
            const m = parseInt(document.getElementById('timerMinutesInput').value || '0');
            sendCommand('SET_TIMER', (h * 60) + m);
        }
        function deleteTimer() { sendCommand('SET_TIMER', 0); }
        function setSchedule() {
            const on = document.getElementById('scheduleOnTime').value;
            const off = document.getElementById('scheduleOffTime').value;
            if (!on || !off) return addLiveNotification('Please select both ON and OFF times.', 'error');
            const [onH, onM] = on.split(':');
            const [offH, offM] = off.split(':');
            sendCommand('SCHED', `${onH},${onM},${offH},${offM}`);
        }
        function deleteSchedule() { sendCommand('DEL_SCHED'); }
        function confirmResetAll() { if(confirm("This will factory reset the device, deleting all settings including WiFi. You will need to provision it again. Are you sure?")) sendCommand('RESET_ALL'); }

        function addLiveNotification(message, type) {
            const panel = document.getElementById('notificationsList'), item = document.createElement('div');
            item.className = `notification notification-${type}`;
            item.innerHTML = `<strong>${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</strong> - ${message}`;
            panel.insertBefore(item, panel.firstChild);
            if (panel.children.length > 20) panel.removeChild(panel.lastChild);
        }

        function applyTheme(isDark) {
            if (isDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            localStorage.setItem('darkMode', isDark);
            document.getElementById('themeToggle').textContent = isDark ? '☀️' : '🌙';
            updateChart(); // This will re-apply the correct colors to the chart
        }

        function toggleDarkMode() {
            const isCurrentlyDark = document.documentElement.hasAttribute('data-theme');
            applyTheme(!isCurrentlyDark);
        }

        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

        // --- GLOBAL ACCESS & INITIALIZATION ---
        window.connectBluetooth = connectBluetooth;
        window.disconnectBluetooth = disconnectBluetooth;
        window.provisionWifi = provisionWifi;
        window.sendCommand = sendCommand;
        window.setKwhRate = setKwhRate;
        window.setBudget = setBudget;
        window.deleteBudget = deleteBudget;
        window.setTimer = setTimer;
        window.deleteTimer = deleteTimer;
        window.setSchedule = setSchedule;
        window.deleteSchedule = deleteSchedule;
        window.confirmResetAll = confirmResetAll;
        window.toggleDarkMode = toggleDarkMode;
        window.toggleFullscreen = toggleFullscreen;
        window.toggleChartType = toggleChartType;
        window.setChartTimeRange = setChartTimeRange;
        window.resetChartZoom = resetChartZoom;
        
        document.addEventListener('DOMContentLoaded', () => {
            const savedThemeIsDark = localStorage.getItem('darkMode') === 'true';
            
            initializeChart(); // Initialize chart first
            applyTheme(savedThemeIsDark); // THEN apply the theme, which will also style the chart
            
            updateConnectionStatus('disconnected');
            setupFirebaseListener();
            if ("Notification" in window && Notification.permission === "default") Notification.requestPermission();
        });
    </script>
</body>
</html>
