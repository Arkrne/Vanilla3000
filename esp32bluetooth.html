<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîå Vanilla 3000 Smart Energy Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.x/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --success-color: #48bb78;
            --error-color: #f56565;
            --warning-color: #ed8936;
            --info-color: #4299e1;
        }

        [data-theme="dark"] {
            --primary-gradient: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --card-bg: rgba(45, 55, 72, 0.95);
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--primary-gradient); min-height: 100vh; padding: 1rem; color: var(--text-primary); transition: all 0.3s ease; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--card-bg); border-radius: 1.5rem; padding: 2rem; box-shadow: 0 20px 40px var(--shadow-color); backdrop-filter: blur(10px); min-height: calc(100vh - 2rem); display: flex; flex-direction: column; }
        .header { text-align: center; margin-bottom: 2rem; position: relative; }
        .header h1 { font-size: 3rem; font-weight: 800; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
        .header p { font-size: 1rem; color: var(--text-secondary); }
        .header-controls { position: absolute; top: 0; right: 0; display: flex; gap: 0.75rem; }
        .header-btn { width: 3rem; height: 3rem; border-radius: 50%; border: 2px solid var(--border-color); background: var(--card-bg); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; transition: all 0.3s ease; }
        .header-btn:hover { background: var(--primary-gradient); color: white; border-color: transparent; }
        .main-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; flex-grow: 1; }
        .section { background: var(--card-bg); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border-color); box-shadow: 0 4px 15px var(--shadow-color); }
        .left-column .section:last-child, .right-column .section:last-child { margin-bottom: 0; }
        .section-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
        .status-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .metric-card { background: var(--primary-gradient); color: white; padding: 1.5rem; border-radius: 1rem; text-align: center; transition: transform 0.2s ease; }
        .metric-card:hover { transform: translateY(-2px); }
        .metric-label { font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem; }
        .metric-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem; }
        .metric-unit { font-size: 0.875rem; opacity: 0.8; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; min-width: 100px; }
        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f56565, #e53e3e); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #a0aec0, #718096); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .input-field { width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 0.5rem; background: var(--card-bg); color: var(--text-primary); font-size: 1rem; transition: border-color 0.3s ease; }
        .input-field:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .control-group, .input-group { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .control-group { flex-wrap: wrap; }
        .input-group { align-items: center; }
        .control-group .btn, .input-group .input-field { flex: 1; }
        .input-group .btn { flex-grow: 0; }
        .connection-status { padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; font-weight: 600; transition: all 0.3s ease;}
        .status-dot { width: 12px; height: 12px; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .connection-status.connected { background: rgba(72, 187, 120, 0.1); color: var(--success-color); border-left: 5px solid var(--success-color); }
        .connection-status.connecting { background: rgba(237, 137, 54, 0.1); color: var(--warning-color); border-left: 5px solid var(--warning-color); }
        .connection-status.disconnected { background: rgba(245, 101, 101, 0.1); color: var(--error-color); border-left: 5px solid var(--error-color); }
        .connection-status.connected .status-dot { background-color: var(--success-color); }
        .connection-status.connecting .status-dot { background-color: var(--warning-color); }
        .connection-status.disconnected .status-dot { background-color: var(--error-color); }
        .chart-container { position: relative; height: 400px; margin-top: 1rem; }
        .chart-controls { display: flex; gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap; justify-content: center; }
        .chart-btn { padding: 0.5rem 1rem; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-primary); border-radius: 0.5rem; cursor: pointer; transition: all 0.3s ease; }
        .chart-btn.active, .chart-btn:hover { background: var(--primary-gradient); color: white; border-color: transparent; }
        .notifications-panel { max-height: 250px; overflow-y: auto; padding-right: 10px; }
        .notification { padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .notification-info { background: rgba(66, 153, 225, 0.1); border-color: var(--info-color); color: var(--info-color); }
        .notification-success { background: rgba(72, 187, 120, 0.1); border-color: var(--success-color); color: var(--success-color); }
        .notification-warning { background: rgba(237, 137, 54, 0.1); border-color: var(--warning-color); color: var(--warning-color); }
        .notification-error { background: rgba(245, 101, 101, 0.1); border-color: var(--error-color); color: var(--error-color); }
        .usage-tracker { text-align: center; padding: 2rem; background: var(--primary-gradient); color: white; border-radius: 1rem; margin-bottom: 1.5rem; }
        .usage-time { font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
        .budget-time-display { background: rgba(118, 75, 162, 0.1); border-radius: 0.75rem; padding: 1rem; margin-top: 0.75rem; text-align: center; font-weight: 600; display: flex; flex-direction: column; gap: 0.5rem; }
        .budget-time-display .label { font-size: 0.8rem; color: var(--text-secondary); }
        .budget-time-display .value { font-size: 1.25rem; font-weight: 800; }
        .schedule-group { display: grid; grid-template-columns: auto 1fr; gap: 1rem; align-items: center; margin-bottom: 1rem;}
        .schedule-group label { font-weight: 600; color: var(--text-secondary); }
        @media (max-width: 1024px) { .main-grid { grid-template-columns: 1fr; } .header-controls { position: static; justify-content: center; margin-top: 1rem; } }
        @media (max-width: 640px) { body { padding: .25rem; } .container { padding: .75rem; } .header h1 { font-size: 1.8rem; } .header p { font-size: .85rem; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîå Vanilla 3000</h1>
            <p>Smart Energy Monitor & Control Panel</p>
            <div class="header-controls">
                <button class="header-btn" onclick="toggleDarkMode()" id="themeToggle">üåô</button>
                <button class="header-btn" onclick="toggleFullscreen()" id="fullscreenToggle">‚õ∂</button>
            </div>
        </div>

        <div class="main-grid">
            <div class="left-column">
                <div class="section">
                    <div class="section-title">üì° Connection</div>
                    <div id="connectionStatus" class="connection-status disconnected">
                        <div class="status-dot"></div>
                        <span id="connectionStatusText">Offline</span>
                    </div>
                    <div class="control-group">
                        <button class="btn btn-primary" onclick="connectDevice()" id="connectBtn">Provision via BLE</button>
                        <button class="btn btn-danger" onclick="disconnectDevice()" id="disconnectBtn" style="display: none;">Disconnect BLE</button>
                    </div>
                </div>

                <div class="section" id="wifiSetupSection" style="display: none;">
                    <div class="section-title">üåê Wi-Fi Provisioning</div>
                      <p class="text-sm text-gray-500 mb-4 -mt-2">Send Wi-Fi details to your device for remote access.</p>
                    <div class="input-group">
                        <input type="text" id="wifiSsidInput" class="input-field" placeholder="Wi-Fi Name (SSID)">
                    </div>
                    <div class="input-group">
                        <input type="password" id="wifiPassInput" class="input-field" placeholder="Wi-Fi Password">
                    </div>
                    <button class="btn btn-primary w-full" onclick="sendWifiCredentials()">Save & Reboot Device</button>
                </div>

                <div class="section">
                    <div class="section-title">‚ö° Energy Rate Configuration</div>
                    <div class="input-group">
                        <input type="number" id="kwhRateInput" class="input-field" placeholder="kWh Rate (e.g., 14.0)" min="0" step="any">
                        <button class="btn btn-primary" onclick="setKwhRate()" id="setKwhRateBtn">Set Rate</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">üéõÔ∏è Device Control</div>
                    <div class="control-group">
                        <button class="btn btn-success" onclick="sendCommand('ON')" id="onBtn">Turn ON</button>
                        <button class="btn btn-danger" onclick="sendCommand('OFF')" id="offBtn">Turn OFF</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">üìÖ Schedule Control</div>
                    <div class="schedule-group">
                        <label for="scheduleOnTime">ON Time:</label>
                        <input type="time" id="scheduleOnTime" class="input-field">
                    </div>
                    <div class="schedule-group">
                        <label for="scheduleOffTime">OFF Time:</label>
                        <input type="time" id="scheduleOffTime" class="input-field">
                    </div>
                    <div class="control-group">
                          <button class="btn btn-primary" onclick="setSchedule()" id="scheduleBtn">Set Schedule</button>
                          <button class="btn btn-danger" onclick="deleteSchedule()" id="deleteScheduleBtn">Delete Schedule</button>
                    </div>
                    <div id="activeScheduleDisplay" class="budget-time-display" style="display:none;">
                        <span class="label">Active Schedule</span>
                        <span class="value" id="activeSchedule"></span>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">üí∞ Budget Control</div>
                    <div class="input-group">
                        <input type="number" id="budgetInput" class="input-field" placeholder="Amount in ‚Ç±" min="0" step="0.01">
                        <button class="btn btn-primary" onclick="setBudget()" id="budgetBtn">Set</button>
                        <button class="btn btn-danger" onclick="deleteBudget()" id="deleteBudgetBtn">Delete</button>
                    </div>
                    <div id="remainingBudgetDisplay" class="budget-time-display" style="display:none;">
                        <span class="label">Remaining Budget</span>
                        <span class="value" id="remainingBudget">‚Ç±0.00</span>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">‚è∞ Timer Control</div>
                    <div class="input-group">
                        <input type="number" id="timerHoursInput" class="input-field" placeholder="Hours" min="0" max="23">
                        <input type="number" id="timerMinutesInput" class="input-field" placeholder="Minutes" min="0" max="59">
                    </div>
                    <div class="control-group">
                        <button class="btn btn-primary" onclick="setTimer()" id="timerBtn">Set Timer</button>
                        <button class="btn btn-danger" onclick="deleteTimer()" id="deleteTimerBtn">Delete Timer</button>
                    </div>
                    <div id="remainingTimerDisplay" class="budget-time-display" style="display:none;">
                        <span class="label">Time Remaining</span>
                        <span class="value" id="remainingTimer">00:00:00</span>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">üîÑ Reset Functions</div>
                    <div class="control-group">
                        <button class="btn btn-warning" onclick="sendCommand('RESET_KWH')" id="resetUsageBtn">Reset Usage</button>
                        <button class="btn btn-warning" onclick="sendCommand('RESET_RUNTIME')" id="resetTimeBtn">Reset Runtime</button>
                        <button class="btn btn-danger" onclick="confirmResetAll()" id="resetAllBtn">Reset All</button>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="status-panel">
                    <div class="metric-card"><div class="metric-label">Voltage</div><div class="metric-value" id="voltage">0.0</div><div class="metric-unit">V</div></div>
                    <div class="metric-card"><div class="metric-label">Current</div><div class="metric-value" id="current">0.00</div><div class="metric-unit">A</div></div>
                    <div class="metric-card"><div class="metric-label">Power</div><div class="metric-value" id="power">0.0</div><div class="metric-unit">W</div></div>
                    <div class="metric-card"><div class="metric-label">Total kWh</div><div class="metric-value" id="energy">0.000</div><div class="metric-unit">kWh</div></div>
                    <div class="metric-card"><div class="metric-label">Total Cost</div><div class="metric-value" id="cost">‚Ç±0.00</div><div class="metric-unit">PHP</div></div>
                </div>
                <div class="usage-tracker"><div class="usage-time" id="usageTime">00:00:00</div><div id="usageStatus">Device Status</div></div>
                <div class="section">
                    <div class="section-title">üìä Energy Usage Chart</div>
                    <div class="chart-container"><canvas id="usageChart"></canvas></div>
                    <div class="chart-controls">
                        <button class="chart-btn" onclick="toggleChartType('power')" id="chartTypePower">Power</button>
                        <button class="chart-btn" onclick="toggleChartType('kwh')" id="chartTypeKwh">kWh</button>
                        <button class="chart-btn" onclick="toggleChartType('cost')" id="chartTypeCost">Cost</button>
                        <button class="chart-btn" onclick="setChartTimeRange('1H')" id="timeRange1H">1H</button>
                        <button class="chart-btn" onclick="setChartTimeRange('24H')" id="timeRange24H">24H</button>
                        <button class="chart-btn" onclick="setChartTimeRange('7D')" id="timeRange7D">7D</button>
                        <button class="chart-btn active" onclick="setChartTimeRange('All')" id="timeRangeAll">All</button>
                        <button class="chart-btn btn-secondary" onclick="resetChartZoom()" id="resetZoomBtn">Reset View</button>
                    </div>
                </div>
                <div class="section"><div class="section-title">üîî Live Notifications</div><div class="notifications-panel" id="notificationsList"></div></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION (ADAFRUIT IO) ---
        const MQTT_BROKER    = "io.adafruit.com";
        const MQTT_PORT      = 443;
        const MQTT_USERNAME  = "Arkrne";
        const MQTT_PASSWORD  = "aio_HvkQ428LwWt7uaWbWvDHaVb3boXk"; 

        const STATUS_TOPIC   = "Arkrne/feeds/device-status";
        const COMMAND_TOPIC  = "Arkrne/feeds/command-feed";

        const BLE_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const BLE_TX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
        const BLE_RX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';

        // --- STATE VARIABLES ---
        let mqttClient = null;
        let bleDevice = null;
        let bleRxCharacteristic = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let chart = null;
        let currentChartType = 'power';
        const chartData = {
            power: [],
            cost: [],
            kwh: [],
            labels: []
        };
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            initializeChart();
            updateConnectionStatusUI();
            const savedRate = localStorage.getItem('kwhRate');
            if (savedRate) document.getElementById('kwhRateInput').value = savedRate;
            connectMQTT();
        });

        // --- CONNECTION LOGIC ---
        async function connectDevice() {
            if (bleDevice && bleDevice.gatt.connected) {
                addLiveNotification('Already connected to a BLE device.', 'info');
                return;
            }
            setButtonLoading('connectBtn', true, 'Connecting...');
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [BLE_SERVICE_UUID] }],
                    optionalServices: [BLE_SERVICE_UUID]
                });
                
                device.addEventListener('gattserverdisconnected', onBLEDisconnected);
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(BLE_SERVICE_UUID);
                const txChar = await service.getCharacteristic(BLE_TX_CHAR_UUID);
                bleRxCharacteristic = await service.getCharacteristic(BLE_RX_CHAR_UUID);
                
                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', onBLEData);
                
                bleDevice = device;
                addLiveNotification('‚úÖ Connected via Bluetooth for provisioning.', 'success');
                document.getElementById('wifiSetupSection').style.display = 'block';
            } catch (error) {
                addLiveNotification(`BLE Connection failed: ${error.message}`, 'error');
            } finally {
                setButtonLoading('connectBtn', false, 'Provision via BLE');
                updateConnectionStatusUI();
            }
        }

        function connectMQTT() {
            updateConnectionStatusUI('connecting');
            const clientId = "user_web_" + Math.random().toString(36).substring(2, 9);
            mqttClient = new Paho.Client(MQTT_BROKER, MQTT_PORT, "/mqtt", clientId);
            
            mqttClient.onConnectionLost = onMQTTConnectionLost;
            mqttClient.onMessageArrived = onMQTTMessage;

            mqttClient.connect({
                userName: MQTT_USERNAME,
                password: MQTT_PASSWORD,
                useSSL: true,
                onSuccess: onMQTTConnect,
                onFailure: (err) => {
                    addLiveNotification(`MQTT connection failed: ${err.errorMessage}`, 'error');
                    updateConnectionStatusUI();
                }
            });
        }

        function onMQTTConnect() {
            mqttClient.subscribe(STATUS_TOPIC);
            addLiveNotification('üöÄ Connected to Adafruit IO for remote access.', 'success');
            updateConnectionStatusUI();
        }
        
        async function disconnectDevice() {
            if (bleDevice && bleDevice.gatt.connected) {
                await bleDevice.gatt.disconnect();
            }
        }

        function onBLEDisconnected() {
            bleDevice = null;
            bleRxCharacteristic = null;
            addLiveNotification('Bluetooth device disconnected.', 'warning');
            document.getElementById('wifiSetupSection').style.display = 'none';
            updateConnectionStatusUI();
        }
        
        function onMQTTConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                addLiveNotification(`MQTT connection lost: ${responseObject.errorMessage}`, 'warning');
                updateConnectionStatusUI();
                setTimeout(connectMQTT, 5000);
            }
        }

        // --- DATA HANDLING & COMMANDS ---
        function onMQTTMessage(message) {
            try {
                const metrics = JSON.parse(message.payloadString);
                updateMetricsUI(metrics);
                addDataPoint(parseFloat(metrics.P), parseFloat(metrics.COST), parseFloat(metrics.KWH));
            } catch (e) { console.warn("Received non-JSON MQTT message:", message.payloadString); }
        }
        
        let bleDataBuffer = '';
        function onBLEData(event) {
            const value = new TextDecoder().decode(event.target.value);
            bleDataBuffer += value;

            let newlineIndex;
            while ((newlineIndex = bleDataBuffer.indexOf('\n')) !== -1) {
                const completeLine = bleDataBuffer.substring(0, newlineIndex).trim();
                bleDataBuffer = bleDataBuffer.substring(newlineIndex + 1);

                if (completeLine) {
                    try {
                        const metrics = JSON.parse(completeLine);
                        updateMetricsUI(metrics);
                        addDataPoint(parseFloat(metrics.P), parseFloat(metrics.COST), parseFloat(metrics.KWH));
                    } catch (e) {
                         console.warn("Received non-JSON BLE message:", completeLine);
                    }
                }
            }
        }

        async function sendCommand(action, value = null) {
            const command = (value !== null) ? `${action}:${value}` : `${action}`;
            
            if (mqttClient && mqttClient.isConnected()) {
                const message = new Paho.Message(command);
                message.destinationName = COMMAND_TOPIC;
                mqttClient.send(message);
            } else if (bleDevice && bleDevice.gatt.connected) {
                 await sendCommandInChunks(command + '\n');
            } else {
                 addLiveNotification('Cannot send command. No active connection.', 'error');
            }
        }
        
        async function sendCommandInChunks(data) {
            if (!bleRxCharacteristic) {
                addLiveNotification('BLE Characteristic not found.', 'error');
                return;
            }
            const CHUNK_SIZE = 20; 
            const encoder = new TextEncoder();
            const encodedData = encoder.encode(data);
            
            for (let i = 0; i < encodedData.length; i += CHUNK_SIZE) {
                const chunk = encodedData.slice(i, i + CHUNK_SIZE);
                await bleRxCharacteristic.writeValueWithoutResponse(chunk);
            }
        }
        
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        async function sendWifiCredentials() {
            const ssid = document.getElementById('wifiSsidInput').value;
            const pass = document.getElementById('wifiPassInput').value;
            if (!ssid) {
                addLiveNotification('Please enter a Wi-Fi Name (SSID).', 'error');
                return;
            }

            if (bleDevice && bleDevice.gatt.connected) {
                try {
                    addLiveNotification('Sending SSID...', 'info');
                    await sendCommandInChunks(`SET_SSID:${ssid}\n`);
                    await sleep(300);

                    addLiveNotification('Sending Password...', 'info');
                    await sendCommandInChunks(`SET_PASS:${pass}\n`);
                    await sleep(300);

                    addLiveNotification('Saving credentials to device...', 'success');
                    await sendCommandInChunks('SAVE_WIFI\n');

                    addLiveNotification('Wi-Fi credentials sent. The device will now reboot.', 'success');
                } catch (error) {
                    addLiveNotification(`Failed to send credentials: ${error.message}`, 'error');
                }
            } else {
                addLiveNotification('Must be connected via Bluetooth to send Wi-Fi credentials.', 'error');
            }
        }


        // --- UI UPDATE FUNCTIONS ---
        function updateMetricsUI(data) {
            if (data.V !== undefined) document.getElementById('voltage').textContent = parseFloat(data.V).toFixed(1);
            if (data.I !== undefined) document.getElementById('current').textContent = parseFloat(data.I).toFixed(2);
            if (data.P !== undefined) document.getElementById('power').textContent = parseFloat(data.P).toFixed(1);
            if (data.KWH !== undefined) document.getElementById('energy').textContent = parseFloat(data.KWH).toFixed(3);
            if (data.COST !== undefined) document.getElementById('cost').textContent = `‚Ç±${parseFloat(data.COST).toFixed(2)}`;
            if (data.Relay !== undefined) document.getElementById('usageStatus').textContent = `Device is currently ${data.Relay}`;
            if (data.RUNTIME !== undefined) {
                const s = parseInt(data.RUNTIME, 10);
                if (!isNaN(s)) {
                    document.getElementById('usageTime').textContent = `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor(s%3600/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
                }
            }
            const timerDisplay = document.getElementById('remainingTimerDisplay');
            if (data.REM_TIME && parseInt(data.REM_TIME, 10) > 0) {
                const s = parseInt(data.REM_TIME, 10);
                document.getElementById('remainingTimer').textContent = `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor(s%3600/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
                timerDisplay.style.display = 'flex';
            } else { timerDisplay.style.display = 'none'; }
            
            const budgetDisplay = document.getElementById('remainingBudgetDisplay');
            if (data.REM_BUDGET && parseFloat(data.REM_BUDGET) > 0) {
                document.getElementById('remainingBudget').textContent = `‚Ç±${parseFloat(data.REM_BUDGET).toFixed(2)}`;
                budgetDisplay.style.display = 'flex';
            } else { budgetDisplay.style.display = 'none'; }
            
            const scheduleDisplay = document.getElementById('activeScheduleDisplay');
            if (data.SCHED_ACTIVE && parseInt(data.SCHED_ACTIVE) === 1) {
                const onTimeParts = data.SCHED_ON.split(':');
                const offTimeParts = data.SCHED_OFF.split(':');
                const onHour12 = parseInt(onTimeParts[0]) % 12 || 12;
                const onAmPm = parseInt(onTimeParts[0]) >= 12 ? 'PM' : 'AM';
                const offHour12 = parseInt(offTimeParts[0]) % 12 || 12;
                const offAmPm = parseInt(offTimeParts[0]) >= 12 ? 'PM' : 'AM';
                document.getElementById('activeSchedule').textContent = `ON: ${onHour12}:${onTimeParts[1].padStart(2,'0')} ${onAmPm} | OFF: ${offHour12}:${offTimeParts[1].padStart(2,'0')} ${offAmPm}`;
                scheduleDisplay.style.display = 'flex';
            } else {
                scheduleDisplay.style.display = 'none';
            }
        }
        
        function updateConnectionStatusUI(mqttState = null) {
            const statusEl = document.getElementById('connectionStatus');
            const statusTextEl = document.getElementById('connectionStatusText');
            const isMqttConnected = mqttClient && mqttClient.isConnected();
            const isBleConnected = bleDevice && bleDevice.gatt.connected;
            const canSendCommand = isMqttConnected || isBleConnected;

            document.getElementById('connectBtn').style.display = isBleConnected ? 'none' : 'flex';
            document.getElementById('disconnectBtn').style.display = isBleConnected ? 'flex' : 'none';

            if (isMqttConnected) {
                statusEl.className = 'connection-status connected';
                statusTextEl.textContent = isBleConnected ? 'MQTT & BLE Connected' : 'MQTT Online';
            } else if (isBleConnected) {
                statusEl.className = 'connection-status connected';
                statusTextEl.textContent = 'BLE Connected';
            } else if (mqttState === 'connecting') {
                 statusEl.className = 'connection-status connecting';
                 statusTextEl.textContent = 'Connecting to MQTT...';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusTextEl.textContent = 'Offline';
            }

            const controlButtons = ['onBtn', 'offBtn', 'budgetBtn', 'deleteBudgetBtn', 'timerBtn', 'deleteTimerBtn', 'setKwhRateBtn', 'resetUsageBtn', 'resetTimeBtn', 'resetAllBtn', 'scheduleBtn', 'deleteScheduleBtn'];
            controlButtons.forEach(id => { 
                const btn = document.getElementById(id); 
                if(btn) btn.disabled = !canSendCommand; 
            });
        }
        
        // --- UI HELPER FUNCTIONS ---
        function setButtonLoading(id, loading, text) {
            const btn = document.getElementById(id);
            btn.disabled = loading;
            btn.innerHTML = loading ? `<div class="spinner"></div> <span>${text}</span>` : text;
        }
        function addLiveNotification(message, type = 'info') {
            const panel = document.getElementById('notificationsList');
            const item = document.createElement('div');
            item.className = `notification notification-${type}`;
            item.innerHTML = `<strong>${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</strong> - ${message}`;
            panel.insertBefore(item, panel.firstChild);
            if (panel.children.length > 20) panel.removeChild(panel.lastChild);
        }
        function setKwhRate() {
            const rateString = document.getElementById('kwhRateInput').value;
            if (/^[0-9]*\.?[0-9]+$/.test(rateString) && parseFloat(rateString) > 0) {
                sendCommand('RATE', rateString);
                localStorage.setItem('kwhRate', rateString);
                addLiveNotification(`kWh rate set to ‚Ç±${rateString}`, 'success');
            } else { addLiveNotification('Invalid rate. Must be a positive number.', 'error'); }
        }
        function setBudget() { 
            const budgetInput = document.getElementById('budgetInput');
            const b = parseFloat(budgetInput.value); 
            if (!isNaN(b) && b > 0) { 
                sendCommand('SET_BUDGET', b);  
                budgetInput.value = ''; 
            } else { 
                addLiveNotification('Please enter a budget greater than 0.', 'error'); 
            } 
        }
        function deleteBudget() { sendCommand('SET_BUDGET', 0); addLiveNotification('Active budget deleted.', 'info'); }
        function setTimer() {
            const h = parseInt(document.getElementById('timerHoursInput').value || '0', 10);
            const m = parseInt(document.getElementById('timerMinutesInput').value || '0', 10);
            const totalMinutes = (h * 60) + m;
            if (totalMinutes > 0) {
                sendCommand('SET_TIMER', totalMinutes);
                addLiveNotification(`Timer set for ${h}h ${m}m.`, 'success');
                document.getElementById('timerHoursInput').value = '';
                document.getElementById('timerMinutesInput').value = '';
            } else {
                addLiveNotification('Please enter a duration greater than 0.', 'error');
            }
        }
        function deleteTimer() { sendCommand('SET_TIMER', 0); addLiveNotification('Active timer deleted.', 'info'); }
        function setSchedule() {
            const onTime = document.getElementById('scheduleOnTime').value;
            const offTime = document.getElementById('scheduleOffTime').value;
            if (!onTime || !offTime) return addLiveNotification('Please select both ON and OFF times.', 'error');
            const [onH, onM] = onTime.split(':').map(Number);
            const [offH, offM] = offTime.split(':').map(Number);
            sendCommand('SCHED', `${onH},${onM},${offH},${offM}`);
            addLiveNotification('Schedule sent to device.', 'success');
        }
        function deleteSchedule() { sendCommand('DEL_SCHED'); addLiveNotification('Schedule deleted.', 'info'); }
        function confirmResetAll() { if(confirm("Are you sure? This will clear all usage data and settings on the device.")) sendCommand('RESET_ALL'); }

        // --- THEME & FULLSCREEN ---
        function initializeTheme() {
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            } else {
                document.documentElement.removeAttribute('data-theme');
                document.getElementById('themeToggle').textContent = 'üåô';
            }
        }
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            initializeTheme();
        }
        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        
        // --- CHART LOGIC ---
        function initializeChart() {
            const ctx = document.getElementById('usageChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line', data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'hour' } }, y: { beginAtZero: true, title: { display: true } } },
                    plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } }
                }
            });
            toggleChartType(currentChartType);
            setChartTimeRange('All');
        }
        function addDataPoint(power, cost, kwh) {
            const now = new Date();
            const nowISO = now.toISOString();

            chartData.labels.push(nowISO);
            chartData.power.push(power);
            chartData.cost.push(cost);
            chartData.kwh.push(kwh);

            while (chartData.labels.length > 2880) { // Keep last 2 days of 1-min data
                Object.keys(chartData).forEach(key => chartData[key].shift());
            }

            if (chart?.data.datasets.length > 0) {
                chart.data.labels.push(now);
                chart.data.datasets[0].data.push({ x: now.getTime(), y: arguments[currentChartType === 'power' ? 0 : currentChartType === 'cost' ? 1 : 2] });
                
                while(chart.data.labels.length > 2880) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }
                if(!chart.isZoomedOrPanned()) {
                    chart.update('none');
                }
            }
        }
        function toggleChartType(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-controls .chart-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`chartType${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');
            updateChart();
        }
        function setChartTimeRange(period) {
            if (!chart) return;
            const now = luxon.DateTime.now();
            let min;
            switch(period) {
                case '1H': min = now.minus({ hours: 1 }); break;
                case '24H': min = now.minus({ days: 1 }); break;
                case '7D': min = now.minus({ weeks: 1 }); break;
                case 'All':
                default: min = chartData.labels.length > 0 ? luxon.DateTime.fromISO(chartData.labels[0]) : now.minus({days: 1}); break;
            }
            chart.options.scales.x.min = min.toMillis();
            chart.options.scales.x.max = now.toMillis();
            chart.update();
            document.querySelectorAll('.chart-controls #timeRange1H, #timeRange24H, #timeRange7D, #timeRangeAll').forEach(b => b.classList.remove('active'));
            document.getElementById(`timeRange${period}`).classList.add('active');
        }
        function updateChart() {
            if (!chart) return;
            const labelMap = { power: 'Power (W)', kwh: 'Energy (kWh)', cost: 'Cost (PHP)' };
            const colorMap = { power: '#667eea', kwh: '#38a169', cost: '#ed8936' };
            
            const data = chartData.labels.map((label, index) => ({
                x: luxon.DateTime.fromISO(label).toMillis(),
                y: chartData[currentChartType][index]
            }));

            chart.data.datasets = [{
                data: data,
                label: labelMap[currentChartType],
                borderColor: colorMap[currentChartType],
                backgroundColor: colorMap[currentChartType] + '1A',
                tension: 0.1,
                fill: true,
                pointRadius: 0,
                borderWidth: 1.5
            }];
            chart.options.scales.y.title.text = labelMap[currentChartType];
            chart.update();
        }
        function resetChartZoom() { if(chart) { chart.resetZoom(); setChartTimeRange('All'); } }

    </script>
</body>
</html>


